generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                    Int                   @id @default(autoincrement())
  email                 String                @unique
  firstName             String
  lastName              String
  password              String?
  role                  Role                  @default(STUDENT)
  userClass             String?
  section               String?
  department            String?
  phone                 String?
  address               String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  profilePhoto          String?
  darkMode              Boolean               @default(false)
  isProfilePrivate      Boolean               @default(false)
  emailVerified         Boolean               @default(false)
  emailVerificationToken String?             @unique
  emailVerificationExpires DateTime?
  resetPasswordToken    String?              @unique
  resetPasswordExpires  DateTime?
  googleId              String?               @unique
  flashcards            Flashcard[]
  forumImages           ForumImage[]
  forumLikes            ForumLike[]
  forumPosts            ForumPost[]
  forumReplies          ForumReply[]
  groupMemberships      GroupMember[]         @relation("GroupMemberships")
  groupMessages         GroupMessage[]        @relation("GroupMessages")
  knowledgeTestResults  KnowledgeTestResult[]
  messageReactions      MessageReaction[]     @relation("MessageReactions")
  messages              Message[]
  notifications         Notification[]        @relation("UserNotifications")
  reviews               Review[]
  studentActivities     StudentActivity[]
  studentStats          StudentStats?
  createdGroups         StudyGroup[]          @relation("CreatedGroups")
  subjectProgress       SubjectProgress[]
  tutorGroupMemberships TutorGroupMember[]
  tutorSessions         TutorSession[]
  tutor                 Tutor?

  @@map("users")
}

model Tutor {
  id             Int            @id @default(autoincrement())
  userId         Int            @unique
  experience     Int
  rating         Float          @default(0)
  isOnline       Boolean        @default(false)
  bio            String?        @db.Text
  hourlyRate     Float?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  certifications String?        @db.Text
  education      String?        @db.Text
  isAvailable    Boolean        @default(true)
  languages      String?
  responseTime   Int?
  specialties    String?        @db.Text
  totalEarnings  Float          @default(0)
  totalSessions  Int            @default(0)
  payments       Payment[]
  reviews        Review[]
  tutorGroups    TutorGroup[]
  sessions       TutorSession[]
  tutorSubjects  TutorSubject[]
  user           User           @relation(fields: [userId], references: [id])

  @@map("tutors")
}

model Subject {
  id                Int               @id @default(autoincrement())
  name              String            @unique
  level             String
  description       String?
  createdAt         DateTime          @default(now())
  section           String?
  difficulty        String?
  totalLessons      Int?
  chapters          Chapter[]
  flashcards        Flashcard[]
  forumPosts        ForumPost[]
  knowledgeTests    KnowledgeTest[]
  studentActivities StudentActivity[]
  studyGroups       StudyGroup[]
  subjectProgress   SubjectProgress[]
  tutors            TutorSubject[]

  @@map("subjects")
}

model Chapter {
  id          Int         @id @default(autoincrement())
  name        String
  subjectId   Int
  description String?
  order       Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  subject     Subject     @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  flashcards  Flashcard[]
  questions   KnowledgeQuestion[]

  @@unique([name, subjectId])
  @@index([subjectId])
  @@map("chapters")
}

model TutorSubject {
  id        Int     @id @default(autoincrement())
  tutorId   Int
  subjectId Int
  subject   Subject @relation(fields: [subjectId], references: [id])
  tutor     Tutor   @relation(fields: [tutorId], references: [id])

  @@unique([tutorId, subjectId])
  @@index([subjectId], map: "tutor_subjects_subjectId_fkey")
  @@map("tutor_subjects")
}

model Flashcard {
  id         Int                @id @default(autoincrement())
  question   String
  answer     String
  subjectId  Int
  userId     Int
  difficulty String             @default("medium")
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  chapterId  Int?
  attempts   FlashcardAttempt[]
  chapter    Chapter?           @relation(fields: [chapterId], references: [id])
  subject    Subject            @relation(fields: [subjectId], references: [id])
  user       User               @relation(fields: [userId], references: [id])

  @@index([subjectId], map: "flashcards_subjectId_fkey")
  @@index([chapterId], map: "flashcards_chapterId_fkey")
  @@index([userId], map: "flashcards_userId_fkey")
  @@map("flashcards")
}

model FlashcardAttempt {
  id          Int       @id @default(autoincrement())
  flashcardId Int
  userId      Int
  isCorrect   Boolean
  timeSpent   Int
  createdAt   DateTime  @default(now())
  flashcard   Flashcard @relation(fields: [flashcardId], references: [id])

  @@index([flashcardId], map: "flashcard_attempts_flashcardId_fkey")
  @@map("flashcard_attempts")
}

model TutorSession {
  id          Int           @id @default(autoincrement())
  tutorId     Int
  studentId   Int
  subject     String
  duration    Int
  status      SessionStatus @default(SCHEDULED)
  scheduledAt DateTime
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  actualEnd   DateTime?
  actualStart DateTime?
  endAt       DateTime?
  feedback    String?       @db.Text
  isPaid      Boolean       @default(false)
  meetingLink String?
  notes       String?       @db.Text
  price       Float?
  rating      Int?
  messages    Message[]
  payment     Payment?
  student     User          @relation(fields: [studentId], references: [id])
  tutor       Tutor         @relation(fields: [tutorId], references: [id])

  @@index([studentId], map: "tutor_sessions_studentId_fkey")
  @@index([tutorId], map: "tutor_sessions_tutorId_fkey")
  @@index([status])
  @@index([scheduledAt])
  @@map("tutor_sessions")
}

model Message {
  id         Int           @id @default(autoincrement())
  sessionId  Int?
  senderId   Int
  receiverId Int
  content    String
  isRead     Boolean       @default(false)
  createdAt  DateTime      @default(now())
  sender     User          @relation(fields: [senderId], references: [id])
  session    TutorSession? @relation(fields: [sessionId], references: [id])

  @@index([senderId], map: "messages_senderId_fkey")
  @@index([sessionId], map: "messages_sessionId_fkey")
  @@map("messages")
}

model Review {
  id        Int      @id @default(autoincrement())
  tutorId   Int
  studentId Int
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  student   User     @relation(fields: [studentId], references: [id])
  tutor     Tutor    @relation(fields: [tutorId], references: [id])

  @@unique([tutorId, studentId])
  @@index([studentId], map: "reviews_studentId_fkey")
  @@map("reviews")
}

model ForumPost {
  id        Int          @id @default(autoincrement())
  title     String
  content   String
  authorId  Int
  subjectId Int?
  isPinned  Boolean      @default(false)
  isLocked  Boolean      @default(false)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  images    ForumImage[]
  likes     ForumLike[]
  author    User         @relation(fields: [authorId], references: [id])
  subject   Subject?     @relation(fields: [subjectId], references: [id])
  replies   ForumReply[]

  @@index([authorId], map: "forum_posts_authorId_fkey")
  @@index([subjectId], map: "forum_posts_subjectId_fkey")
  @@map("forum_posts")
}

model ForumReply {
  id        Int          @id @default(autoincrement())
  content   String
  postId    Int
  authorId  Int
  parentId  Int?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  images    ForumImage[]
  likes     ForumLike[]
  author    User         @relation(fields: [authorId], references: [id])
  parent    ForumReply?  @relation("ReplyReplies", fields: [parentId], references: [id])
  replies   ForumReply[] @relation("ReplyReplies")
  post      ForumPost    @relation(fields: [postId], references: [id])

  @@index([authorId], map: "forum_replies_authorId_fkey")
  @@index([parentId], map: "forum_replies_parentId_fkey")
  @@index([postId], map: "forum_replies_postId_fkey")
  @@map("forum_replies")
}

model ForumLike {
  id        Int         @id @default(autoincrement())
  userId    Int
  postId    Int?
  replyId   Int?
  createdAt DateTime    @default(now())
  post      ForumPost?  @relation(fields: [postId], references: [id])
  reply     ForumReply? @relation(fields: [replyId], references: [id])
  user      User        @relation(fields: [userId], references: [id])

  @@unique([userId, postId])
  @@unique([userId, replyId])
  @@index([postId], map: "forum_likes_postId_fkey")
  @@index([replyId], map: "forum_likes_replyId_fkey")
  @@map("forum_likes")
}

model ForumImage {
  id         Int         @id @default(autoincrement())
  filename   String
  filepath   String
  mimetype   String
  size       Int
  postId     Int?
  replyId    Int?
  uploadedBy Int
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  post       ForumPost?  @relation(fields: [postId], references: [id], onDelete: Cascade)
  reply      ForumReply? @relation(fields: [replyId], references: [id], onDelete: Cascade)
  uploader   User        @relation(fields: [uploadedBy], references: [id])

  @@index([postId], map: "forum_images_postId_fkey")
  @@index([replyId], map: "forum_images_replyId_fkey")
  @@index([uploadedBy], map: "forum_images_uploadedBy_fkey")
  @@map("forum_images")
}

model KnowledgeTest {
  id             Int                   @id @default(autoincrement())
  title          String
  description    String?
  subjectId      Int
  totalQuestions Int
  timeLimit      Int
  passingScore   Int
  isActive       Boolean               @default(true)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  questions      KnowledgeQuestion[]
  results        KnowledgeTestResult[]
  subject        Subject               @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([subjectId])
  @@map("knowledge_tests")
}

model KnowledgeQuestion {
  id            Int                   @id @default(autoincrement())
  testId        Int
  chapterId     Int?
  question      String
  type          QuestionType
  options       Json?
  correctAnswer String
  explanation   String?
  difficulty    Difficulty            @default(MEDIUM)
  concept       String?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  test          KnowledgeTest         @relation(fields: [testId], references: [id], onDelete: Cascade)
  chapter       Chapter?              @relation(fields: [chapterId], references: [id], onDelete: SetNull)
  answers       KnowledgeTestAnswer[]

  @@index([testId])
  @@index([chapterId])
  @@map("knowledge_questions")
}

model KnowledgeTestResult {
  id          Int                   @id @default(autoincrement())
  testId      Int
  userId      Int
  score       Int
  percentage  Float
  timeSpent   Int
  isPassed    Boolean
  completedAt DateTime              @default(now())
  answers     KnowledgeTestAnswer[]
  test        KnowledgeTest         @relation(fields: [testId], references: [id])
  user        User                  @relation(fields: [userId], references: [id])

  @@index([testId])
  @@index([userId])
  @@map("knowledge_test_results")
}

model KnowledgeTestAnswer {
  id         Int                 @id @default(autoincrement())
  resultId   Int
  questionId Int
  userAnswer String
  isCorrect  Boolean
  timeSpent  Int
  question   KnowledgeQuestion   @relation(fields: [questionId], references: [id])
  result     KnowledgeTestResult @relation(fields: [resultId], references: [id], onDelete: Cascade)

  @@index([resultId])
  @@index([questionId])
  @@map("knowledge_test_answers")
}

model StudyGroup {
  id          Int            @id @default(autoincrement())
  name        String
  description String?        @db.Text
  subjectId   Int
  creatorId   Int
  isPrivate   Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  section     String?
  userClass   String?
  members     GroupMember[]
  messages    GroupMessage[]
  creator     User           @relation("CreatedGroups", fields: [creatorId], references: [id])
  subject     Subject        @relation(fields: [subjectId], references: [id])

  @@index([subjectId])
  @@index([creatorId])
  @@index([userClass])
  @@index([section])
  @@map("study_groups")
}

model GroupMessage {
  id          Int               @id @default(autoincrement())
  groupId     Int
  userId      Int
  content     String            @db.Text
  createdAt   DateTime          @default(now())
  audioUrl    String?
  messageType MessageType       @default(TEXT)
  fileName    String?
  fileSize    Int?
  fileType    String?
  replyToId   Int?              // ID du message auquel on répond (fonctionnalité WhatsApp)
  fileUrl     String?
  isPinned    Boolean           @default(false)
  pinnedAt    DateTime?
  pinnedBy    Int?
  group       StudyGroup        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user        User              @relation("GroupMessages", fields: [userId], references: [id])
  reactions   MessageReaction[]

  @@index([groupId])
  @@index([userId])
  @@index([isPinned])
  @@map("group_messages")
}

model MessageReaction {
  id        Int          @id @default(autoincrement())
  messageId Int
  userId    Int
  emoji     String
  createdAt DateTime     @default(now())
  message   GroupMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User         @relation("MessageReactions", fields: [userId], references: [id])

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
  @@map("message_reactions")
}

model GroupMember {
  id       Int        @id @default(autoincrement())
  groupId  Int
  userId   Int
  role     MemberRole @default(MEMBER)
  joinedAt DateTime   @default(now())
  group    StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User       @relation("GroupMemberships", fields: [userId], references: [id])

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("group_members")
}

model StudentStats {
  id                  Int      @id @default(autoincrement())
  studentId           Int      @unique
  flashcardsCompleted Int      @default(0)
  studyStreak         Int      @default(0)
  averageScore        Float    @default(0)
  timeSpentMinutes    Int      @default(0)
  totalSubjects       Int      @default(0)
  completedLessons    Int      @default(0)
  upcomingTests       Int      @default(0)
  achievements        Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  student             User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("student_stats")
}

model StudentActivity {
  id        Int          @id @default(autoincrement())
  studentId Int
  subjectId Int?
  type      ActivityType
  title     String
  score     Int?
  createdAt DateTime     @default(now())
  student   User         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject   Subject?     @relation(fields: [subjectId], references: [id])

  @@index([studentId])
  @@index([subjectId])
  @@index([createdAt])
  @@map("student_activities")
}

model SubjectProgress {
  id               Int       @id @default(autoincrement())
  studentId        Int
  subjectId        Int
  completedLessons Int       @default(0)
  nextLesson       String?
  lastStudiedAt    DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  student          User      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject          Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([studentId, subjectId])
  @@index([studentId])
  @@index([subjectId])
  @@map("subject_progress")
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  type      NotificationType
  title     String
  message   String           @db.Text
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model Conversation {
  id            Int             @id @default(autoincrement())
  studentId     Int
  tutorId       Int
  lastMessageAt DateTime        @default(now())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  isBlocked     Boolean         @default(false)
  blockReason   String?         @db.Text
  blockedAt     DateTime?
  messages      DirectMessage[]

  @@unique([studentId, tutorId])
  @@index([studentId])
  @@index([tutorId])
  @@index([lastMessageAt])
  @@map("conversations")
}

model DirectMessage {
  id             Int          @id @default(autoincrement())
  senderId       Int
  receiverId     Int
  content        String       @db.Text
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
  audioUrl       String?
  conversationId Int
  fileName       String?
  fileSize       Int?
  replyToId      Int?         // ID du message auquel on répond (fonctionnalité WhatsApp)
  fileType       String?
  fileUrl        String?
  messageType    MessageType  @default(TEXT)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
  @@index([createdAt])
  @@map("direct_messages")
}

model Payment {
  id            Int           @id @default(autoincrement())
  sessionId     Int           @unique
  tutorId       Int
  studentId     Int
  amount        Float
  currency      String        @default("XAF")
  status        PaymentStatus @default(PENDING)
  method        String?
  transactionId String?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  session       TutorSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tutor         Tutor         @relation(fields: [tutorId], references: [id])

  @@index([sessionId])
  @@index([tutorId])
  @@index([studentId])
  @@index([status])
  @@map("payments")
}

model TutorGroup {
  id              Int                @id @default(autoincrement())
  tutorId         Int
  name            String
  description     String?            @db.Text
  subjectId       Int?
  maxStudents     Int                @default(10)
  currentStudents Int                @default(0)
  price           Float
  schedule        String?            @db.Text
  isActive        Boolean            @default(true)
  startDate       DateTime?
  endDate         DateTime?
  meetingLink     String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  members         TutorGroupMember[]
  tutor           Tutor              @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([tutorId])
  @@index([subjectId])
  @@index([isActive])
  @@map("tutor_groups")
}

model TutorGroupMember {
  id        Int               @id @default(autoincrement())
  groupId   Int
  studentId Int
  status    GroupMemberStatus @default(PENDING)
  joinedAt  DateTime          @default(now())
  paidAt    DateTime?
  group     TutorGroup        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student   User              @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([groupId, studentId])
  @@index([groupId])
  @@index([studentId])
  @@index([status])
  @@map("tutor_group_members")
}

enum Role {
  STUDENT
  TUTOR
  ADMIN
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MemberRole {
  ADMIN
  MODERATOR
  MEMBER
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  LONG_ANSWER
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum ActivityType {
  FLASHCARD
  TEST
  LESSON
  ACHIEVEMENT
}

enum MessageType {
  TEXT
  VOICE
  IMAGE
  FILE
}

enum NotificationType {
  FORUM_REPLY
  FORUM_LIKE
  GROUP_MESSAGE
  GROUP_INVITE
  TEST_RESULT
  ACHIEVEMENT
  SYSTEM
  TUTOR_MESSAGE
  SESSION_REMINDER
  SESSION_REQUEST
  PAYMENT_RECEIVED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum GroupMemberStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
}
